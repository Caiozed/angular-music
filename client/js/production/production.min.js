var interval,app=angular.module("angularMusic",["ngRoute","ngCookies","ngFileUpload"]);function request($http,method,url,data,success,error){$http({method:method,url:url,data:data}).then(function(response){success(response)},function(response){error(response)})}function redirectTo(path){window.location=path}function current_user(){return JSON.parse(window.sessionStorage.getItem("user_info"))}function isLoggedIn(){return!!current_user()}function loginRedirect(){isLoggedIn()&&redirectTo("#!menu")}function logoutRedirect(){isLoggedIn()||redirectTo("#!")}function toggleTimer(audio,progressbar,$rootScope,currentTime){var totalTime=document.getElementById("total-time");$rootScope.paused?clearInterval(interval):interval=setInterval(function(){totalTime.textContent=formatTime(audio.duration),currentTime.textContent=formatTime(audio.currentTime);var width=audio.currentTime/audio.duration*100;progressbar.setAttribute("value",width)},100)}function formatTime(seconds){var minutes;return(minutes=(minutes=Math.floor(seconds/60))>=10?minutes:"0"+minutes)+":"+(seconds=(seconds=Math.floor(seconds%60))>=10?seconds:"0"+seconds)}app.config(function($routeProvider){$routeProvider.when("/",{templateUrl:"../templates/start.html",resolve:{init:function(){loginRedirect()}}}).when("/signup",{templateUrl:"../templates/signup.html"}).when("/login",{templateUrl:"../templates/login.html"}).when("/menu",{templateUrl:"../templates/menu.html",resolve:{init:function($rootScope){logoutRedirect(),$rootScope.current_user=current_user()}}}).when("/albums/:id",{templateUrl:"../templates/album.html",resolve:{init:function($rootScope){logoutRedirect(),$rootScope.current_user=current_user()}}})}),app.run(function($rootScope){var audio=document.getElementById("audio"),progress=document.getElementById("progress"),currentTime=document.getElementById("current-time"),album_name=document.getElementById("album-name"),song_name=document.getElementById("song-name"),volume=document.getElementById("volume"),playerImage=document.getElementById("playerbar-image");volume.oninput=function(){audio.volume=this.value/100},audio.oncanplay=function(){audio.play()},audio.onended=function(){$rootScope.nextSong($rootScope.current_song,$rootScope.album)},$rootScope.paused=!0,$rootScope.logOut=function(){window.localStorage.clear(),window.sessionStorage.clear(),redirectTo("#!")},$rootScope.isLoggedIn=function(){return isLoggedIn()},$rootScope.currentUser=function(){return current_user()},$rootScope.playSong=function(song,album){audio.setAttribute("src",song.song),playerImage.setAttribute("src",album.image),song_name.textContent=song.name,album_name.textContent=album.name,audio.load(),$rootScope.current_song=song,$rootScope.current_album=album,$rootScope.paused=!1,toggleTimer(audio,progress,$rootScope,currentTime)},$rootScope.playToggle=function(){var audio=document.getElementById("audio"),progress=document.getElementById("progress"),currentTime=document.getElementById("current-time");audio.paused?(audio.play(),toggleTimer(audio,progress,$rootScope,currentTime),$rootScope.paused=!1):(audio.pause(),toggleTimer(audio,progress,$rootScope,currentTime),$rootScope.paused=!0)},$rootScope.nextSong=function(song,album){$rootScope.paused=!1;var songs=$rootScope.current_songs,nextSongIndex=songs.indexOf(song)+1;nextSongIndex>songs.length-1&&(nextSongIndex=0),$rootScope.playSong(songs[nextSongIndex],album)},$rootScope.previousSong=function(song,album){$rootScope.paused=!1;var songs=$rootScope.current_songs,nextSongIndex=songs.indexOf(song)-1;nextSongIndex<0&&(nextSongIndex=songs.length-1),$rootScope.playSong(songs[nextSongIndex],album)}}),app.controller("signupCtrl",function($scope,$rootScope,$cookies,$http){$scope.submitUser=function(username,password,password_confirmation){request($http,"POST","/new/user",{username:username,password:password},function(response){console.log(response),redirectTo("#!login")},function(response){console.log(response)})},$scope.confirmUserData=function(username,password,password_confirmation){username&&password&&password==password_confirmation?$scope.submitUser(username,password,password_confirmation):$scope.messages=["Passwords must match!","Username must have at least 3 characters"]}}),app.controller("loginCtrl",function($scope,$rootScope,$http,$window){$scope.login=function(username,password,remember_me){request($http,"POST","/login",{username:username,password:password},function(response){if(0==response.data.length)$scope.messages=["Wrong username or password"];else{var user_info={id:response.data[0].id,username:response.data[0].username};remember_me&&$window.localStorage.setItem("user_info",JSON.stringify(user_info)),$scope.isLoggedIn=!0,$window.sessionStorage.setItem("user_info",JSON.stringify(user_info)),redirectTo("#!menu")}},function(response){console.log(response)})}}),app.controller("mainMenuCtrl",function($scope,$rootScope,$cookies,$http,Upload){$scope.getAlbums=function(){request($http,"GET","/albums",{},function(response){0==response.data.length?$scope.messages=["No albums"]:Array.isArray(response.data)?$scope.albums=response.data:$scope.albums=[response.data]},function(response){console.log(response)})},$scope.addAlbum=function(name,image){Upload.upload({url:"/new/album",data:{name:name,image:image,artist_id:$rootScope.current_user.id}}).then(function(resp){$scope.getAlbums(),console.log("Success"+resp)})},$scope.getAlbums()}),app.controller("albumCtrl",function($scope,$rootScope,$cookies,$http,$routeParams,Upload){$scope.current_user=current_user(),$scope.getAlbum=function(){request($http,"GET","/albums/"+$routeParams.id,{},function(response){0==response.data.length?$scope.messages=["No albums"]:$scope.album=response.data[0]},function(response){console.log(response)})},$scope.getSongs=function(){request($http,"GET","/albums/"+$routeParams.id+"/songs",{},function(response){0==response.data.length?$scope.messages=["No albums"]:Array.isArray(response.data)?($rootScope.current_songs=$scope.songs=response.data,$scope.setCurrentSong(response.data[0])):($rootScope.current_songs=$scope.songs=[response.data],$scope.setCurrentSong(response.data))},function(response){console.log(response)})},$scope.addSong=function(name,song){Upload.upload({url:"/new/song",data:{name:name,song:song,album_id:$routeParams.id}}).then(function(resp){$scope.getSongs(),console.log("Success"+resp)})},$scope.setCurrentSong=function(data){void 0==$rootScope.current_song&&($rootScope.current_song=data)},$scope.getAlbum(),$scope.getSongs()});