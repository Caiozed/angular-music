var app=angular.module("angularMusic",["ngRoute","ngCookies","ngFileUpload"]);function request($http,method,url,data,success,error){$http({method:method,url:url,data:data}).then(function(response){success(response)},function(response){error(response)})}function redirectTo(path){window.location=path}function current_user(){return JSON.parse(window.sessionStorage.getItem("user_info"))}function isLoggedIn(){return!!current_user()}function logOut(){window.sessionStorage.clear(),window.sessionStorage.clear(),redirectTo("#!login")}app.config(function($routeProvider){$routeProvider.when("/",{templateUrl:"../templates/start.html",resolve:{init:function($cookies){$cookies.get("user_id")&&redirectTo("#!menu")}}}).when("/signup",{templateUrl:"../templates/signup.html"}).when("/login",{templateUrl:"../templates/login.html"}).when("/menu",{templateUrl:"../templates/menu.html"}).when("/albums/:id",{templateUrl:"../templates/album.html"})}),app.controller("signupCtrl",function($scope,$rootScope,$cookies,$http){$scope.submitUser=function(username,password,password_confirmation){request($http,"POST","/new/user",{username:username,password:password},function(response){console.log(response),redirectTo("#!login")},function(response){console.log(response)})},$scope.confirmUserData=function(username,password,password_confirmation){username&&password&&password==password_confirmation?$scope.submitUser(username,password,password_confirmation):$scope.messages=["Passwords must match!","Username must have at least 3 characters"]}}),app.controller("loginCtrl",function($scope,$rootScope,$http,$window){$scope.login=function(username,password,remember_me){request($http,"POST","/login",{username:username,password:password},function(response){if(0==response.data.length)$scope.messages=["Wrong username or password"];else{var user_info={id:response.data[0].id,username:response.data[0].username};remember_me&&$window.localStorage.setItem("user_info",JSON.stringify(user_info)),$scope.isLoggedIn=!0,$window.sessionStorage.setItem("user_info",JSON.stringify(user_info)),redirectTo("#!menu")}},function(response){console.log(response)})}}),app.controller("mainMenuCtrl",function($scope,$rootScope,$cookies,$http,Upload){$scope.current_user=current_user(),$scope.getAlbums=function(){request($http,"GET","/albums",{},function(response){0==response.data.length?$scope.messages=["No albums"]:Array.isArray(response.data)?$scope.albums=response.data:$scope.albums=[response.data]},function(response){console.log(response)})},$scope.addAlbum=function(name,image){Upload.upload({url:"/new/album",data:{name:name,image:image,artist_id:$scope.current_user.id}}).then(function(resp){$scope.getAlbums(),console.log("Success"+resp)})},$scope.getAlbums()}),app.controller("albumCtrl",function($scope,$rootScope,$cookies,$http,$routeParams,Upload){$scope.current_user=current_user(),$scope.getAlbum=function(){request($http,"GET","/albums/"+$routeParams.id,{},function(response){0==response.data.length?$scope.messages=["No albums"]:$scope.album=response.data[0]},function(response){console.log(response)})},$scope.getSongs=function(){request($http,"GET","/albums/"+$routeParams.id+"/songs",{},function(response){0==response.data.length?$scope.messages=["No albums"]:Array.isArray(response.data)?$scope.songs=response.data:$scope.songs=[response.data]},function(response){console.log(response)})},$scope.addSong=function(name,song){Upload.upload({url:"/new/song",data:{name:name,song:song,album_id:$routeParams.id}}).then(function(resp){$scope.getSongs(),console.log("Success"+resp)})},$scope.getAlbum(),$scope.getSongs()});